<dataTemplate name="TRUCKFILL" description="TRUCKFILL">
    <parameters>
        <parameter name="P_GL_USER" dataType="character" defaultValue="DBA.ADMIN" />
        <parameter name="P_ROLE_ID" dataType="character" defaultValue="ADMIN" />
        <parameter name="P_DATE_TIME_FORMAT" dataType="character" />
        <parameter name="P_YEAR" dataType="character" />

    </parameters>
    <lexicals />
    <dataQuery>


        <sqlStatement name="Q_CATEGORY">
            <![CDATA[
SELECT
NVL(temp.DISPATCH_CATEGORY,'OTHER')																				DISPATCH_CATEGORY
-- ,temp.ftl_ltl																									FTL_LTL
-- ,temp.sh_start_time																								START_TIME
-- ,temp.truck_capacity_pfs																						    TRUCK_CAPACITY_PFS
-- ,temp.truck_capacity_weight																						TRUCK_CAPACITY_WEIGHT
-- ,round(AVG(TEMP.PFS_PERC),2)																		                PFS_PERCENTAGE
-- ,round(AVG(TEMP.WEIGHT_PERC),2)																		            WEIGHT_PERC
,ROUND(AVG(TEMP.WEIGHT_PERC),2)									                                                WEIGHT_PERCENTAGE
,ROUND(AVG(TEMP.PFS_PERC),2)															                        PFS_PERCENTAGE
,SUM(temp.total_cost_eur)																						TOTAL_COST_EUR
,SUM(TEMP.WASTAGE) 				                                                                                WASTAGE

FROM(
SELECT sh.shipment_gid																							SHIPMENT_GID
,sh.source_location_gid																							SOURCE_LOCATION_GID
,sh.dest_location_gid																							DEST_LOCATION_GID
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))                               								SOURCE_CITY
,UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))																DEST_CITY
,sh.source_location_gid||'-'||sh.dest_location_gid																UTMS_KEY
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))||'-'||UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))		LANE_NAME
,to_char(sh.start_time,'MM')																									SH_START_TIME
,(CASE WHEN (UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
))) = 'INBOUND' THEN
(
'INBOUND-'||(SELECT loc.location_refnum_value
FROM location_refnum loc
WHERE loc.location_gid = sh.source_location_gid
AND loc.location_refnum_qual_gid = 'ULE.ULE_LTL_DBR'
))

ELSE
(UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
)))

END)																																					DISPATCHING_REGION

,NVL(
(UPPER((SELECT listagg(sh_ref.RATE_GEO_REFNUM_VALUE,'/') within group (order by sh.shipment_gid)
                  FROM rate_geo_refnum sh_ref
                  WHERE sh_ref.rate_geo_gid = sh.rate_geo_gid
                  AND sh_ref.RATE_GEO_REFNUM_QUAL_GID = 'ULE.RG_CATEGORY'))),

(case
         WHEN ( UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
                        FROM shipment_refnum sh_ref
                        WHERE sh_ref.shipment_gid = sh.shipment_gid
                        AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_MATERIAL_TYPE'))) <> 'FINISHED GOODS' THEN

         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
                  FROM location_refnum loc_ref
                  WHERE loc_ref.location_gid = sh.DEST_LOCATION_GID
                  AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY'))
                  )
         ELSE
         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
               FROM location_refnum loc_ref
               WHERE loc_ref.location_gid = sh.source_location_gid
               AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY' ))
         ) END )
      )                                                                                                                                                                        DISPATCH_CATEGORY

,UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
FROM location_refnum loc_ref
WHERE loc_ref.location_gid = sh.dest_location_gid
AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_MSO'

))																																                                                RECEIVING_MSO
,CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

))

ELSE sh.total_num_reference_units			END																											                        PFS
--,sh.total_num_reference_units	PFS


,sh.total_weight_base*0.45359237																																				PALLET_GROSS_WEIGHT_KG


,(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)																																									TRUCK_CAPACITY_PFS

,(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)
)																																									TRUCK_CAPACITY_WEIGHT

,(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	)																																								EQUIPMENT_TYPE

,nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST

		        FROM shipment_cost alloc_d

                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)																											                                                    TOTAL_COST_EUR



,round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
         to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

         FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

         WHERE egeru.EQUIPMENT_GROUP_GID =
         (SELECT s_eq.equipment_group_gid
         FROM shipment_s_equipment_join sh_eq_j
         ,s_equipment s_eq
         WHERE
         sh.shipment_gid = sh_eq_j.shipment_gid
         AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
         AND rownum <2
         	)

         AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

         ))

         ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)																																								PFS_PERC

,CASE WHEN (round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) > 1 THEN 1
ELSE
(round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) END																																								WEIGHT_PERC

,(CASE WHEN (
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				WHEN alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
                FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
		        AND alloc_d.IS_WEIGHTED = 'N'
		        AND alloc_d.COST_TYPE in ('B','A')
)),0)) < 0 THEN 0 ELSE
TO_NUMBER(
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
		        FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)) END) *
((CASE WHEN
(
round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
        to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

        FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

        WHERE egeru.EQUIPMENT_GROUP_GID =
        (SELECT s_eq.equipment_group_gid
        FROM shipment_s_equipment_join sh_eq_j
        ,s_equipment s_eq
        WHERE
        sh.shipment_gid = sh_eq_j.shipment_gid
        AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
        AND rownum <2
        	)

        AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

        ))

        ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)
) > (CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END
) THEN

(1-(round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
            to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

            FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

            WHERE egeru.EQUIPMENT_GROUP_GID =
            (SELECT s_eq.equipment_group_gid
            FROM shipment_s_equipment_join sh_eq_j
            ,s_equipment s_eq
            WHERE
            sh.shipment_gid = sh_eq_j.shipment_gid
            AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
            AND rownum <2
            	)

            AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

            ))

            ELSE sh.total_num_reference_units			END	)/
    		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

    FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

    WHERE egeru.EQUIPMENT_GROUP_GID =
    (SELECT s_eq.equipment_group_gid
    FROM shipment_s_equipment_join sh_eq_j
    ,s_equipment s_eq
    WHERE
    sh.shipment_gid = sh_eq_j.shipment_gid
    AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
    AND rownum <2
    	)

    AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

    )),2)))

ELSE
 (1-(CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END	)
 )

END
))                                                                                                                                                           WASTAGE


FROM shipment sh
,location s_loc
,location d_loc

WHERE 1=1
AND s_loc.location_gid = sh.source_location_gid
AND d_loc.location_gid = sh.dest_location_gid
--AND sh.start_time >= to_date('2016-01-01','YYYY-MM-DD')
--AND sh.start_time < to_date('2016-05-01','YYYY-MM-DD')

AND TO_CHAR(sh.start_time,'YYYY') = :P_YEAR
AND TO_CHAR(sh.start_time,'MM') <= TO_CHAR(TRUNC(SYSDATE,'MM')-1,'MM')

AND NOT exists
	(SELECT 1
		FROM shipment_refnum sh_ref_1
		WHERE sh_ref_1.shipment_Refnum_Qual_Gid = 'ULE.ULE_SHIPMENT_STREAM'
		AND sh_ref_1.shipment_Refnum_Value = 'SECONDARY'
		AND sh_ref_1.shipment_gid = SH.shipment_gid)
AND sh.domain_name <> 'UGO'
AND NOT exists (SELECT 1
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
AND sh_ref.shipment_refnum_value IN ('INBOUND','BULK')
)
AND	sh.shipment_type_gid = 'TRANSPORT'


AND NOT exists
(SELECT 1
FROM shipment_stop ss
,location_refnum lrp
WHERE
ss.shipment_gid = sh.shipment_gid
AND lrp.LOCATION_GID = ss.location_gid
AND lrp.location_refnum_qual_gid = 'ULE.ULE_SEND_TO_LOGISTAR'
)
and EXISTS (SELECT 1
		FROM
		SHIPMENT_STATUS SH_STATUS
		WHERE
		SH_STATUS.SHIPMENT_GID = SH.SHIPMENT_GID
		AND SH_STATUS.STATUS_TYPE_GID = 'ULE/PR.TRANSPORT CANCELLATION'
		AND SH_STATUS.STATUS_VALUE_GID = 'ULE/PR.NOT CANCELLED'
		)


AND
(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	) <> 'ULE.UNLIMITED'
) temp

group by
-- temp.ftl_ltl
NVL(temp.DISPATCH_CATEGORY,'OTHER')

-- order by temp.DISPATCHING_REGION
-- ,temp.ftl_ltl
---added
--eq <> unlimited

-----15.04.2016---------------------------------------------------------------------------------------------------
-- inbound as separate line in summary/receiving country  --- -priority


-- wastage 1- % * spend ---DONE
--add wastage to dashboard --DONE
--add receiving country to lane --DONE

--check with kasia 500 pfs on shipments --DONE

--top 10 lanes pfs wastage on dashboard
------------------19.04.2016-------------------------------------------------------------------------------
--ULE_LTL_DBR REFNUM PER LOC WYSYLAJACA, INBOUND I BULK WIDOCZNY W SPLIT PER REGION,   INBOUND_SOUTH_EUROPE + INBOUND OVERALL  -
--BULK WEIGHT %				DONE
--INCLUDE FLATTO TO REGIONS   DONE
--LTL ONLY FG IN REGIONS SPLIT CANCELLED
--PER LANE DODAC FLAGE FLATTO			DONE
--YTD W SHEETACH LANES I DISPATCH       DONE
--SREDNIA WAGA NA LANES I DISPATCH (JUZ JEST PFS SREDNI)	DONE
--FLAGA LTL W ZAKLADCE LANES					CANCELLED

----25.04.2016----------------
--FTL/LTL  TOGETHER IN DASHBOARD SPLIT IN LANES     DONE


-----check 1 pallets in epoca

--STREAM PRIMARY / COST REPORTING GROUP FROM SAP
--USCC PLATNIKA
--BULKOW/INBOUND BRAK
--PFS VS ILOSC PALET
--total cost ???
---------16.05.2016-------------------------------------------------------------------------------
--TODO missing cat then from source loc
--TODO sending loc for FG // receiving RP if missing






]]>
        </sqlStatement>
        <sqlStatement name="Q_REGION">
            <![CDATA[
SELECT
temp.DISPATCHING_REGION																							DISPATCHING_REGION
-- ,temp.sh_start_time																								START_TIME
-- ,temp.truck_capacity_pfs																						TRUCK_CAPACITY_PFS
-- ,temp.truck_capacity_weight																						TRUCK_CAPACITY_WEIGHT
,ROUND(AVG(TEMP.WEIGHT_PERC),6)									                                                WEIGHT_PERCENTAGE
,CASE WHEN TEMP.DISPATCHING_REGION <> 'BULK' THEN  ROUND(AVG(TEMP.PFS_PERC),6) ELSE 0 END					    PFS_PERCENTAGE
,SUM(temp.total_cost_eur)																						TOTAL_COST_EUR
,SUM(TEMP.WASTAGE) 				                                                                                WASTAGE

FROM(

SELECT sh.shipment_gid																							SHIPMENT_GID
,sh.source_location_gid																							SOURCE_LOCATION_GID
,sh.dest_location_gid																							DEST_LOCATION_GID
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))                               								SOURCE_CITY
,UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))																DEST_CITY
,sh.source_location_gid||'-'||sh.dest_location_gid																UTMS_KEY
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))||'-'||UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))		LANE_NAME
,to_char(sh.start_time,'MM')																									SH_START_TIME
,(CASE WHEN (UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
))) = 'INBOUND' THEN
(
'INBOUND-'||(SELECT loc.location_refnum_value
FROM location_refnum loc
WHERE loc.location_gid = sh.source_location_gid
AND loc.location_refnum_qual_gid = 'ULE.ULE_LTL_DBR'
))

ELSE
(UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
)))

END)																																					DISPATCHING_REGION

,NVL(
(UPPER((SELECT listagg(sh_ref.RATE_GEO_REFNUM_VALUE,'/') within group (order by sh.shipment_gid)
                  FROM rate_geo_refnum sh_ref
                  WHERE sh_ref.rate_geo_gid = sh.rate_geo_gid
                  AND sh_ref.RATE_GEO_REFNUM_QUAL_GID = 'ULE.RG_CATEGORY'))),

(case
         WHEN ( UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
                        FROM shipment_refnum sh_ref
                        WHERE sh_ref.shipment_gid = sh.shipment_gid
                        AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_MATERIAL_TYPE'))) <> 'FINISHED GOODS' THEN

         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
                  FROM location_refnum loc_ref
                  WHERE loc_ref.location_gid = sh.DEST_LOCATION_GID
                  AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY'))
                  )
         ELSE
         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
               FROM location_refnum loc_ref
               WHERE loc_ref.location_gid = sh.source_location_gid
               AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY' ))
         ) END )
      )                                                                                                                                                                        DISPATCH_CATEGORY

,UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
FROM location_refnum loc_ref
WHERE loc_ref.location_gid = sh.dest_location_gid
AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_MSO'

))																																                                                RECEIVING_MSO
,CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

))

ELSE sh.total_num_reference_units			END																											                        PFS
--,sh.total_num_reference_units	PFS


,sh.total_weight_base*0.45359237																																				PALLET_GROSS_WEIGHT_KG


,(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)																																									TRUCK_CAPACITY_PFS

,(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)
)																																									TRUCK_CAPACITY_WEIGHT

,(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	)																																								EQUIPMENT_TYPE

,nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST

		        FROM shipment_cost alloc_d

                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)																											                                                    TOTAL_COST_EUR



,round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
         to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

         FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

         WHERE egeru.EQUIPMENT_GROUP_GID =
         (SELECT s_eq.equipment_group_gid
         FROM shipment_s_equipment_join sh_eq_j
         ,s_equipment s_eq
         WHERE
         sh.shipment_gid = sh_eq_j.shipment_gid
         AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
         AND rownum <2
         	)

         AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

         ))

         ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)																																								PFS_PERC

,CASE WHEN (round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) > 1 THEN 1
ELSE
(round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) END																																								WEIGHT_PERC

,(CASE WHEN (
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				WHEN alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
                FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
		        AND alloc_d.IS_WEIGHTED = 'N'
		        AND alloc_d.COST_TYPE in ('B','A')
)),0)) < 0 THEN 0 ELSE
TO_NUMBER(
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
		        FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)) END) *
((CASE WHEN
(
round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
        to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

        FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

        WHERE egeru.EQUIPMENT_GROUP_GID =
        (SELECT s_eq.equipment_group_gid
        FROM shipment_s_equipment_join sh_eq_j
        ,s_equipment s_eq
        WHERE
        sh.shipment_gid = sh_eq_j.shipment_gid
        AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
        AND rownum <2
        	)

        AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

        ))

        ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)
) > (CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END
) THEN

(1-(round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
            to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

            FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

            WHERE egeru.EQUIPMENT_GROUP_GID =
            (SELECT s_eq.equipment_group_gid
            FROM shipment_s_equipment_join sh_eq_j
            ,s_equipment s_eq
            WHERE
            sh.shipment_gid = sh_eq_j.shipment_gid
            AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
            AND rownum <2
            	)

            AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

            ))

            ELSE sh.total_num_reference_units			END	)/
    		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

    FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

    WHERE egeru.EQUIPMENT_GROUP_GID =
    (SELECT s_eq.equipment_group_gid
    FROM shipment_s_equipment_join sh_eq_j
    ,s_equipment s_eq
    WHERE
    sh.shipment_gid = sh_eq_j.shipment_gid
    AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
    AND rownum <2
    	)

    AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

    )),2)))

ELSE
 (1-(CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END	)
 )

END
))                                                                                                                                                           WASTAGE


FROM shipment sh
,location s_loc
,location d_loc

WHERE 1=1
AND s_loc.location_gid = sh.source_location_gid
AND d_loc.location_gid = sh.dest_location_gid
AND TO_CHAR(sh.start_time,'YYYY') = :P_YEAR
AND TO_CHAR(sh.start_time,'MM') <= TO_CHAR(TRUNC(SYSDATE,'MM')-1,'MM')
AND NOT exists
	(SELECT 1
		FROM shipment_refnum sh_ref_1
		WHERE sh_ref_1.shipment_Refnum_Qual_Gid = 'ULE.ULE_SHIPMENT_STREAM'
		AND sh_ref_1.shipment_Refnum_Value = 'SECONDARY'
		AND sh_ref_1.shipment_gid = SH.shipment_gid)
AND sh.domain_name <> 'UGO'

AND	sh.shipment_type_gid = 'TRANSPORT'


AND NOT exists
(SELECT 1
FROM shipment_stop ss
,location_refnum lrp
WHERE
ss.shipment_gid = sh.shipment_gid
AND lrp.LOCATION_GID = ss.location_gid
AND lrp.location_refnum_qual_gid = 'ULE.ULE_SEND_TO_LOGISTAR'
)
and EXISTS (SELECT 1
		FROM
		SHIPMENT_STATUS SH_STATUS
		WHERE
		SH_STATUS.SHIPMENT_GID = SH.SHIPMENT_GID
		AND SH_STATUS.STATUS_TYPE_GID = 'ULE/PR.TRANSPORT CANCELLATION'
		AND SH_STATUS.STATUS_VALUE_GID = 'ULE/PR.NOT CANCELLED'
		)


AND
(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	) <> 'ULE.UNLIMITED'

	and

	(CASE WHEN (UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
    FROM shipment_refnum sh_ref
    WHERE sh_ref.shipment_gid = sh.shipment_gid
    AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
    ))) = 'INBOUND' THEN
    (
    'INBOUND-'||(SELECT loc.location_refnum_value
    FROM location_refnum loc
    WHERE loc.location_gid = sh.source_location_gid
    AND loc.location_refnum_qual_gid = 'ULE.ULE_LTL_DBR'
    ))

    ELSE
    (UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
    FROM shipment_refnum sh_ref
    WHERE sh_ref.shipment_gid = sh.shipment_gid
    AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
    )))

    END) is not null
) temp

group by rollup (temp.dispatching_region)
ORDER BY temp.dispatching_region






]]>
        </sqlStatement>
        <sqlStatement name="Q_MSO">
            <![CDATA[
            SELECT
temp.RECEIVING_MSO																							RECEIVING_MSO
-- ,temp.sh_start_time																								START_TIME
-- ,temp.truck_capacity_pfs																						TRUCK_CAPACITY_PFS
-- ,temp.truck_capacity_weight																						TRUCK_CAPACITY_WEIGHT
,ROUND(AVG(TEMP.WEIGHT_PERC),2)									                                                WEIGHT_PERCENTAGE
,ROUND(AVG(TEMP.PFS_PERC),2)															                        PFS_PERCENTAGE
,SUM(temp.total_cost_eur)																						TOTAL_COST_EUR
,SUM(TEMP.WASTAGE) 				                                                                                WASTAGE

FROM(


SELECT sh.shipment_gid																							SHIPMENT_GID
,sh.source_location_gid																							SOURCE_LOCATION_GID
,sh.dest_location_gid																							DEST_LOCATION_GID
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))                               								SOURCE_CITY
,UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))																DEST_CITY
,sh.source_location_gid||'-'||sh.dest_location_gid																UTMS_KEY
,UPPER(convert(s_loc.city,'US7ASCII','AL32UTF8'))||'-'||UPPER(convert(d_loc.city,'US7ASCII','AL32UTF8'))		LANE_NAME
,to_char(sh.start_time,'MM')																									SH_START_TIME


,NVL(
(UPPER((SELECT listagg(sh_ref.RATE_GEO_REFNUM_VALUE,'/') within group (order by sh.shipment_gid)
                  FROM rate_geo_refnum sh_ref
                  WHERE sh_ref.rate_geo_gid = sh.rate_geo_gid
                  AND sh_ref.RATE_GEO_REFNUM_QUAL_GID = 'ULE.RG_CATEGORY'))),

(case
         WHEN ( UPPER((SELECT listagg(sh_ref.shipment_refnum_value,'/') within group (order by sh.shipment_gid)
                        FROM shipment_refnum sh_ref
                        WHERE sh_ref.shipment_gid = sh.shipment_gid
                        AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_MATERIAL_TYPE'))) <> 'FINISHED GOODS' THEN

         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
                  FROM location_refnum loc_ref
                  WHERE loc_ref.location_gid = sh.DEST_LOCATION_GID
                  AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY'))
                  )
         ELSE
         (UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
               FROM location_refnum loc_ref
               WHERE loc_ref.location_gid = sh.source_location_gid
               AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_CATEGORY' ))
         ) END )
      )                                                                                                                                                                        DISPATCH_CATEGORY

,UPPER((SELECT listagg(NVL(loc_ref.location_refnum_value,'n/a'),'/') within group (order by sh.source_location_gid)
FROM location_refnum loc_ref
WHERE loc_ref.location_gid = sh.dest_location_gid
AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_MSO'

))																																                                                RECEIVING_MSO
,CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

))

ELSE sh.total_num_reference_units			END																											                        PFS
--,sh.total_num_reference_units	PFS


,sh.total_weight_base*0.45359237																																				PALLET_GROSS_WEIGHT_KG


,(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)																																									TRUCK_CAPACITY_PFS

,(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)
)																																									TRUCK_CAPACITY_WEIGHT

,(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	)																																								EQUIPMENT_TYPE

,nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST

		        FROM shipment_cost alloc_d

                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)																											                                                    TOTAL_COST_EUR



,round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
         to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

         FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

         WHERE egeru.EQUIPMENT_GROUP_GID =
         (SELECT s_eq.equipment_group_gid
         FROM shipment_s_equipment_join sh_eq_j
         ,s_equipment s_eq
         WHERE
         sh.shipment_gid = sh_eq_j.shipment_gid
         AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
         AND rownum <2
         	)

         AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

         ))

         ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)																																								PFS_PERC

,CASE WHEN (round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) > 1 THEN 1
ELSE
(round((
sh.total_weight_base*0.45359237/
(SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

FROM EQUIPMENT_GROUP EG
WHERE EG.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
))),2)) END																																								WEIGHT_PERC

,(CASE WHEN (
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				WHEN alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
                FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
		        AND alloc_d.IS_WEIGHTED = 'N'
		        AND alloc_d.COST_TYPE in ('B','A')
)),0)) < 0 THEN 0 ELSE
TO_NUMBER(
nvl(TRIM(
(SELECT
SUM(case when (alloc_d.COST_GID = 'EUR' OR alloc_d.COST_GID IS null) THEN alloc_d.cost
				when alloc_d.COST_GID <> 'EUR' THEN alloc_d.cost *
				unilever.ebs_procedures_ule.get_quarterly_ex_rate(nvl(sh.start_time,SYSDATE-60),alloc_d.COST_GID,'EUR')
				ELSE 0
				END	)						COST
		        FROM shipment_cost alloc_d
                WHERE alloc_d.SHIPMENT_GID = sh.SHIPMENT_GID
                AND alloc_d.IS_WEIGHTED = 'N'
                AND alloc_d.COST_TYPE in ('B','A')
)),0)) END) *
((CASE WHEN
(
round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
        to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

        FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

        WHERE egeru.EQUIPMENT_GROUP_GID =
        (SELECT s_eq.equipment_group_gid
        FROM shipment_s_equipment_join sh_eq_j
        ,s_equipment s_eq
        WHERE
        sh.shipment_gid = sh_eq_j.shipment_gid
        AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
        AND rownum <2
        	)

        AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

        ))

        ELSE sh.total_num_reference_units			END	)/
		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

WHERE egeru.EQUIPMENT_GROUP_GID =
(SELECT s_eq.equipment_group_gid
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
AND rownum <2
	)

AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

)),2)
) > (CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END
) THEN

(1-(round(((CASE WHEN NVL(sh.total_num_reference_units,0) > 33 THEN
            to_number((SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

            FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

            WHERE egeru.EQUIPMENT_GROUP_GID =
            (SELECT s_eq.equipment_group_gid
            FROM shipment_s_equipment_join sh_eq_j
            ,s_equipment s_eq
            WHERE
            sh.shipment_gid = sh_eq_j.shipment_gid
            AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
            AND rownum <2
            	)

            AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

            ))

            ELSE sh.total_num_reference_units			END	)/
    		(SELECT listagg(egeru.LIMIT_NUM_REFERENCE_UNITS,'/') within group (order by sh.shipment_gid)

    FROM 		EQUIP_GROUP_EQUIP_REF_UNIT  egeru

    WHERE egeru.EQUIPMENT_GROUP_GID =
    (SELECT s_eq.equipment_group_gid
    FROM shipment_s_equipment_join sh_eq_j
    ,s_equipment s_eq
    WHERE
    sh.shipment_gid = sh_eq_j.shipment_gid
    AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
    AND rownum <2
    	)

    AND egeru.EQUIPMENT_REFERENCE_UNIT_GID = 'ULE.PFS-EURO_PAL'

    )),2)))

ELSE
 (1-(CASE WHEN (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) > 1 THEN 1
     ELSE
     (round((
     sh.total_weight_base*0.45359237/
     (SELECT round(EG.EFFECTIVE_WEIGHT_BASE*0.45359237,0)

     FROM EQUIPMENT_GROUP EG
     WHERE EG.EQUIPMENT_GROUP_GID =
     (SELECT s_eq.equipment_group_gid
     FROM shipment_s_equipment_join sh_eq_j
     ,s_equipment s_eq
     WHERE
     sh.shipment_gid = sh_eq_j.shipment_gid
     AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
     AND rownum <2
     ))),2)) END	)
 )

END
))                                                                                                                                                           WASTAGE


FROM shipment sh
,location s_loc
,location d_loc

WHERE 1=1
AND s_loc.location_gid = sh.source_location_gid
AND d_loc.location_gid = sh.dest_location_gid
AND TO_CHAR(sh.start_time,'YYYY') = :P_YEAR
AND TO_CHAR(sh.start_time,'MM') <= TO_CHAR(TRUNC(SYSDATE,'MM')-1,'MM')
AND NOT exists
	(SELECT 1
		FROM shipment_refnum sh_ref_1
		WHERE sh_ref_1.shipment_Refnum_Qual_Gid = 'ULE.ULE_SHIPMENT_STREAM'
		AND sh_ref_1.shipment_Refnum_Value = 'SECONDARY'
		AND sh_ref_1.shipment_gid = SH.shipment_gid)
AND sh.domain_name <> 'UGO'
AND NOT exists (SELECT 1
FROM shipment_refnum sh_ref
WHERE sh_ref.shipment_gid = sh.shipment_gid
AND sh_ref.shipment_refnum_qual_gid = 'ULE.ULE_FUNCTIONAL_REGION'
AND sh_ref.shipment_refnum_value IN ('INBOUND','BULK')
)
AND	sh.shipment_type_gid = 'TRANSPORT'


AND NOT exists
(SELECT 1
FROM shipment_stop ss
,location_refnum lrp
WHERE
ss.shipment_gid = sh.shipment_gid
AND lrp.LOCATION_GID = ss.location_gid
AND lrp.location_refnum_qual_gid = 'ULE.ULE_SEND_TO_LOGISTAR'
)
and EXISTS (SELECT 1
		FROM
		SHIPMENT_STATUS SH_STATUS
		WHERE
		SH_STATUS.SHIPMENT_GID = SH.SHIPMENT_GID
		AND SH_STATUS.STATUS_TYPE_GID = 'ULE/PR.TRANSPORT CANCELLATION'
		AND SH_STATUS.STATUS_VALUE_GID = 'ULE/PR.NOT CANCELLED'
		)


AND
(SELECT listagg(s_eq.equipment_group_gid,'/') within group (order by sh.shipment_gid)
FROM shipment_s_equipment_join sh_eq_j
,s_equipment s_eq
WHERE
sh.shipment_gid = sh_eq_j.shipment_gid
AND sh_eq_j.s_equipment_gid = s_eq.s_equipment_gid
	) <> 'ULE.UNLIMITED'

AND EXISTS	(SELECT 1
    FROM location_refnum loc_ref
    WHERE loc_ref.location_gid = sh.dest_location_gid
    AND loc_ref.location_refnum_qual_gid = 'ULE.ULE_MSO')
) temp

group by
-- temp.ftl_ltl
temp.RECEIVING_MSO

-- order by temp.DISPATCHING_REGION
-- ,temp.ftl_ltl
---added
--eq <> unlimited



]]>
        </sqlStatement>

    </dataQuery>
    <dataStructure>
        <group name="Q_CATEGORY" dataType="varchar2" source="Q_CATEGORY">
            <element name="DISPATCH_CATEGORY" dataType="varchar2" value="DISPATCH_CATEGORY" />
            <element name="WEIGHT_PERCENTAGE" dataType="varchar2" value="WEIGHT_PERCENTAGE" />
            <element name="PFS_PERCENTAGE" dataType="varchar2" value="PFS_PERCENTAGE" />
            <element name="TOTAL_COST_EUR" dataType="varchar2" value="TOTAL_COST_EUR" />
            <element name="WASTAGE" dataType="varchar2" value="WASTAGE" />
        </group>
        <group name="Q_REGION" dataType="varchar2" source="Q_REGION">
            <element name="DISPATCHING_REGION" dataType="varchar2" value="DISPATCHING_REGION" />
            <element name="WEIGHT_PERCENTAGE" dataType="varchar2" value="WEIGHT_PERCENTAGE" />
            <element name="PFS_PERCENTAGE" dataType="varchar2" value="PFS_PERCENTAGE" />
            <element name="TOTAL_COST_EUR" dataType="varchar2" value="TOTAL_COST_EUR" />
            <element name="WASTAGE" dataType="varchar2" value="WASTAGE" />
        </group>
        <group name="Q_MSO" dataType="varchar2" source="Q_MSO">
            <element name="RECEIVING_MSO" dataType="varchar2" value="RECEIVING_MSO" />
            <element name="WEIGHT_PERCENTAGE" dataType="varchar2" value="WEIGHT_PERCENTAGE" />
            <element name="PFS_PERCENTAGE" dataType="varchar2" value="PFS_PERCENTAGE" />
            <element name="TOTAL_COST_EUR" dataType="varchar2" value="TOTAL_COST_EUR" />
            <element name="WASTAGE" dataType="varchar2" value="WASTAGE" />
        </group>


    </dataStructure>
</dataTemplate>